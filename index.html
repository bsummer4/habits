<html><head><style>

    span.refutable { text-decoration:underline; }
    span.refutable:hover { background-color:yellow; }

</style></head><body>

<p>
    <form name="x" action="javascript:addHabitHandler()">
        Add a habit
        <input name="habit" value="habit" type="text" id="habit"></input>
        </form>
    <ul id="notices"></ul>
    </p>

<script src="http://code.jquery.com/jquery-1.11.0.min.js"></script>
<script>
// You still need to do $h, $i, $j, and $k today.
// Yesterday, you fucked up on $h, $i, $j, and $k.
// Gratz! You've been doing $h for $x days in a row!
// Gratz! You've been doing $k for $y days in a row!
// (["api","chains"],"GET",[("upto",d)])
// (["api","habits"],"LIST",[])
// (["api","habits",h],"PUT",[])
// (["api","habits",h],"DELETE",[])
// (["api","habits","done"],"GET",[("day",d),("status",s)])
// (["api","habits",h,"done"],"POST",[("day",d),("status",s)])

var refutable = function(name, refute) {
    var result = $("<span class=refutable>");
    result.text(name);
    result.click(refute);
    return result; }

var addHabitHandler = function(x) {
    var hab = document.getElementById("habit").value;
    addHabit(hab, update)(); }

var trace = function(x) { console.log(x); return x; }

var json = function(s) {
    if (s) {return JSON.parse(trace(s)); }
    else {return {}}; }

var delHabit = function(habit,cont) {
    return (function () {
        $.ajax({ type: "DELETE", url: "/api/habits/" + habit })
            .done(function() { cont({}); }); }); }

var addHabit = function(habit, cont) {
    return (function () {
        $.ajax({ type: "PUT", url: "/api/habits/" + habit })
            .done(function() { cont({}); }); }); }

var allHabits = function(cont) {
    $.ajax({ type: "LIST", url: "/api/habits" })
        .done(function(habitsStr) { cont(json(habitsStr)); }); }

var successes = function(day, cont) {
    $.ajax({ type: "GET", url: "/api/habits/done?status=True&day=" + day })
        .done(function(habitsStr) { cont(json(habitsStr)); }) }

var calcFailures = function(habitSet, successSet) {
    var result = [];
    for (i in habitSet) {
        if (-1 === successSet.indexOf(habitSet[i])){ result.push(habitSet[i]); }}
    return result; }

var update = function() {
    allHabits(function(habitSet) {
        successes("today", function(successSet) {
            var failureSet = calcFailures(habitSet,successSet);
            writeDOM(habitSet, successSet, failureSet); }); }); }

var setDone = function(day, habit, status, cont) {
    var statusstr = "True";
    if (true!==status) { statusstr = "False"; }
    return function() {
        $.ajax({
            type: "POST",
            url: ("/api/habits/"+habit+"/done?day="+day+"&status="+statusstr),
            success: function(d){ cont({}); }})}; }

var writeDOM = function(habitSet, successSet, failureSet) {
    var node = $("#notices");
    node.empty()

    console.log(habitSet);
    console.log(successSet);
    console.log(failureSet);

    var habitLI = $("<li>")
    habitLI.append("Habits:");
    for (var i in habitSet) {
        habitLI.append(" ");
        habitLI.append(refutable(habitSet[i],delHabit(habitSet[i],update))); }

    var successLI = $("<li>");
    successLI.append("You succeeded at:");
    for (var i in successSet) {
        successLI.append(" ");
        successLI.append(refutable(successSet[i],
            setDone("today", successSet[i], false, update))); }

    var failureLI = $("<li>");
    failureLI.append("You failed at:");
    for (var i in failureSet) {
        failureLI.append(" ");
        failureLI.append(refutable(failureSet[i],
            setDone("today", failureSet[i], true, update))); }

    node.append(habitLI);
    node.append(successLI);
    node.append(failureLI); }

update();

</script>
</body>
</html>

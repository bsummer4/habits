<html><head><style>
  div.toplevel { width:400px; margin:0 auto; }
  ul#notices { padding: 0; }
  h1.header { text-align:center; }

  .refutable {
    border-width:1; border-style:solid;
    padding:2px; margin:1px; display:inline-block; }

  .pairLeft { margin-right:0 }
  .pairRight { margin-left:-2; }

  .datechange { forground-color:blue; text-decoration:underline; }
  .success { background-color:#88ff88; border-color:#228822; }
  .failure { background-color:#ff8888; border-color:#882222; }
  .notapplicable { background-color:yellow; border-color:darkyellow; }
  .refutable:hover { background-color:yellow; }

  ul.note { padding: 0; list-style: none; }
  li.note:hover { background-color:yellow; }
  li.note {
    padding: 3px;
    margin: 2px;
    display: inline-block;
    width: 388px;
    border-width: 0 2px 0 2px;
    border-style: solid; }

</style></head><body>

<div class="toplevel">
  <ul id="notices"></ul>
  <br><br>
  <ul id="habitList"></ul>
  </div>

<script src="//code.jquery.com/jquery-1.11.0.min.js"></script>
<script>
Date.prototype.modifiedJulianDay = function() {
  return Math.floor((this/86400000)-(this.getTimezoneOffset()/1440)+40587); }

var tok = ""
var user = ""
var julian = function(d) { return d.modifiedJulianDay(); }
var epoch = julian(new Date(0))
var fromJulian = function(j) { return new Date(86400000*(j-epoch)); }
var day = julian(new Date());
var shiftDate = function(n,cont){ return(function(){ day+=n; cont(); });}
var member = function(i,a) { return !(-1 === a.indexOf(i)); }
var noteDOM = function(name, callback) {
  var result = $("<li>");
  result.addClass("note")
  result.text(name);
  result.click(callback);
  return result; }

var habitDOM = function(name, status, tail, callback) {
  var result = $("<span>");
  result.addClass("refutable")
  result.text(name);
  result.click(callback);
  if (status) result.addClass(status);
  if (tail) result.append(tail);
  return result; }

var rpc = function (tok,ty,req,cont) {
  obj = {}
  obj[ty] = [tok,req];
  var opts = {
    type:"PUT", url:"/", dataType:"json", processData:false, data:toJSON(obj)}
  $.ajax(opts).success(function(s) { cont(s); }); }

var addHabit = function(habit, cont) {
  return function() { rpc(tok,"Update",{AddHabit:[user,habit]},cont); }; }

var addHabitHandler = function() {
  var hab = document.getElementById("habit").value;
  addHabit(hab, update)(); }

var addNote = function(note, cont) {
  return function() { rpc(tok,"Update",{AddNote:[user,day,note]},cont); }; }

var addNoteHandler = function() {
  var not = document.getElementById("note").value;
  addNote(not, update)(); }

var trace = function(x) { console.log(x); return x; }
var toJSON = function(s) { return JSON.stringify(s); }

var json = function(s) {
  if (s) {return JSON.parse(s); }
  else {return {}}; }

var getChains = function(cont) {
  rpc(tok,"Query",{GetChains:[user,day]},cont); }

var delNote = function(note,cont) {
  return function() {
    rpc(tok,"Update",{DelNote:[user,day,note]},cont); }}

var delHabit = function(habit,cont) {
  return function() {
    rpc(tok,"Update",{DelHabit:[user,habit]},cont); }}

var getNotes = function(cont) {
  rpc(tok,"Query",{GetNotes:[user,day]},cont); }

var allHabits = function(cont) {
  rpc(tok,"Query",{ListHabits:user},cont); }

var successSetFromAllHabits = function(habitSet, response) {
  var result = [];
  statuses = response["STATUSES"]
  // console.log(toJSON(habitSet));
  // console.log(toJSON(response));
  for (habitName in statuses) {
    if ("Success" in statuses[habitName] && member(habitName,habitSet)) {
      result.push(habitName); }}
  // console.log(toJSON(result));
  return result; }

var habitsStatus = function(habitSet, day, cont) {
  rpc(tok,"Query",{"GetHabitsStatus":[user,day]},function(r){
    cont(r["STATUSES"]); }); }

var calcFailures = function(habitSet, successSet) {
  var result = [];
  for (i in habitSet) {
    if (-1 === successSet.indexOf(habitSet[i])){ result.push(habitSet[i]); }}
  return result; }

var update = function() {
  getChains(function(chainsResponse) {
    chains = chainsResponse["CHAINS"]
    getNotes(function(noteResponse) {
      notes = noteResponse["NOTES"];
      allHabits(function(response) {
        var habitSet = response["HABITS"]
        habitsStatus(habitSet, day, function(statuses) {
          writeDOM(habitSet, statuses, notes, chains); }); }); }); }); }

var setDone = function(day, habit, statusCode, cont) {
  var status;
  if (statusCode == "success") { status={"Success":null}; }
  else if (statusCode == "failure") { status={"Failure":null}; }
  else if (statusCode == "unspecified") { status={"Unspecified":[]}; }
  else { throw "bad statusCode"; }
  return (function() {
    rpc(tok,"Update",{"SetHabitsStatus":[user,day,habit,status]}, cont); }); }


var strSortInPlace = function (x) {
  x.sort(function(a,b){
    var t1 = "".concat(a);
    t1.toUpperCase();
    var t2 = "".concat(b);
    t2.toUpperCase();
    // console.log(t2);
    return t1.localeCompare(t2); }); }


var orWhat = function(n) {
  if (n===null || n.length===0) { return '?'; }
  return n; }

var writeDOM = function(habitSet, statuses, notes, chains) {
  var hdr = $("<h1>");
  hdr.addClass("header")
  var back = $("<span>&lt;&lt;</span>");
  var forward = $("<span>&gt;&gt;</span>");
  back.addClass("datechange");
  forward.addClass("datechange");
  back.click(shiftDate(-1, update));
  forward.click(shiftDate(1, update));
  hdr.append(back);
  var d = fromJulian(day)
  hdr.append(" "+d.getFullYear()+"/"+d.getMonth()+"/"+d.getDate()+" ");
  hdr.append(forward);

  var habitList = $("<p>");
  var habitNames = Object.keys(statuses);
  strSortInPlace(habitNames);
  for (i in habitNames) {
    var status, alt, nm=habitNames[i], num=null;
    // console.log(status);
    if ("Success" in statuses[nm])
      { status="success"; alt="failure"; num=orWhat(statuses[nm]["Success"]); }
    else if ("Failure" in statuses[nm])
      { status="failure"; alt="unspecified"; num=orWhat(statuses[nm]["Failure"]); }
    else if ("Unspecified" in statuses[nm])
      { status="unspecified"; alt="success"; }
    else
      { status="unspecified"; alt=true; }
    console.log(statuses[nm])
    var tail = null;
    if (nm in chains) { tail = $("<sup>"); tail.text(chains[nm]) }
    var nameMe = $('<span style="white-space:nowrap">');
    var habitThing = habitDOM(json(toJSON(nm)),status,tail,
      setDone(day,json(toJSON(nm)),alt,update));
    if (null !== num) { habitThing.addClass("pairLeft"); }
    nameMe.append(habitThing);
    if (null !== num) {
      console.log(nm);
      console.log(status);
      console.log(num);
      var hack = $('<sub contenteditable="true">')
      hack.text(num);
      hack.addClass("refutable")
      if (status) { hack.addClass(status); }
      hack.addClass("pairRight");
      nameMe.append(hack); }
    habitList.append(nameMe);
    habitList.append($("<span>"));
    }

  // console.log(notes)
  strSortInPlace(notes);
  // console.log(notes)
  var noteListFak = $("<p>");
  var noteList = $("<ul>");
  noteList.addClass("note");
  noteListFak.append(noteList)
  for (i in notes) {
    noteList.append(noteDOM(json(toJSON(notes[i])),delNote(notes[i],update)));
    noteList.append("<br>"); }

  var addNoteForm = $("<form name=\"x\" action=\"javascript:addNoteHandler()\">");
  addNoteForm.append($("<input name=\"note\" value=\"Add a Note\" type=\"text\" id=\"note\">"));

  var allHabitsForm = $("<form name=\"x\" action=\"javascript:addHabitHandler()\">");
  var allHabitsP = $("<p>");
  for (var i in habitSet) {
    allHabitsP.append(habitDOM(habitSet[i],null,null,delHabit(habitSet[i],update))); }
  allHabitsP.append($("<input name=\"habit\" value=\"Add a habit\" type=\"text\" id=\"habit\">"));
  allHabitsForm.append(allHabitsP);

  var node = $("#notices");
  node.empty()
  node.append(hdr);
  node.append(habitList);
  node.append(noteListFak);
  node.append(addNoteForm);
  node.append($("<hr><hr><hr><hr>"));
  node.append(allHabitsForm); }

user = prompt("Username","isan");
(function () {
  var pass = prompt("Password","");
  var obj = {"Register":[user,pass]}
  var opts = {
    type:"POST", url:"/", dataType:"json", processData:false, data:toJSON(obj)}
  $.ajax(opts).success(function(response) {
    tok=response["AUTH"];
    update(); }); })();

</script>
</body>
</html>

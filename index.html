<html><head><style>

img {
    max-width: 100%;
    height: 100%;
    position: fixed;
    left: 0; }
    top: 0; }


</style></head><body>

<p><img id="theimg"></img></p>

<script>
var username = "stephen";

var trace = function(x) { console.log(x); return x; }
var i = 0;
var setupKeys = null;
var next = null;
var slideshow = false;

var lines = function(str) {
    var r = str.split("\n");
    if ((r[r.length-1]).length == 0) { r.pop(); }
    return r; };

var shuffle = function (o) {
    for (var j, x, i = o.length ; i;) {
        j=Math.floor(Math.random() * i);
        x=o[--i]; o[i]=o[j]; o[j]=x; }
    return o; };

var DONE = 4;

var picList =
    ["http://www.wallpaper4me.com/images/wallpapers/hour_glass_loading_w1.jpeg"]

var recvPicList = function(xhr) { return (function() {
    if (xhr.readyState!==DONE) return;
    if (xhr.responseText===null) return;
    picList = trace(shuffle(JSON.parse(xhr.responseText)));
    next(1); })}

var getPicList = function() {
    var r = new XMLHttpRequest();
    reqUrl = "/api/users/" + username + "/urls"
    r.onreadystatechange = recvPicList(r);
    r.open("GET", reqUrl, true);
    r.send(); }

next = function(diff) {
    i = i + diff;
    if (picList.length==0) return;
    if (i >= picList.length) { i=0; }
    if (i < 0) { i=picList.length-1; }
    var imgNode = document.getElementById("theimg");
    imgNode.src = picList[i];
    setupKeys(); };

pushUrl = function(url) {
    reqUrl = "/api/users/" + username + "/urls/" + encodeURIComponent(url);
    var r = new XMLHttpRequest();
    // TODO Double check the conditions for this callback.
    r.onreadystatechange = function() {
        if (r.readyState===DONE) { getPicList(); }}
    r.open("PUT", reqUrl, true);
    r.send(); }

addUrl = function() {
    url = prompt("Enter the url of an image");
    if (url === null) { return; }
    var imgNode = document.getElementById("theimg");
    imgNode.src = url;
    picList = getPicList();
    pushUrl(url); }

setupKeys = function() {
    document.getElementById("theimg").onclick = (function(event) { next(1); })
    document.onkeypress = (function(event) {
        if (event.which == 0) return;
        char = String.fromCharCode(event.which);
        switch (char) {
            case 'l': case 'L': next(1); break;
            case 'h': case 'H': next(-1); break;
            case '+': addUrl();
            case ' ': if (slideshow) {slideshow=false;} else {slideshow=true;};
            defeault: break; };});};

getPicList();
next(0);
window.setInterval(function(){ if (slideshow) { next(1); }}, 5000);

</script>
</body>
</html>

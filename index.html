<html><head></head><body>

<p><ul id="notices"></ul></p>

<script src="http://code.jquery.com/jquery-1.11.0.min.js"></script>
<script>
// You still need to do $h, $i, $j, and $k today.
// Yesterday, you fucked up on $h, $i, $j, and $k.
// Gratz! You've been doing $h for $x days in a row!
// Gratz! You've been doing $k for $y days in a row!

var trace = function(x) { console.log(x); return x; }

// data Notice = {"failed",day,habit} | {"chain",habit,length}

var failureNotices = function(habits) {
    console.log($.map(habits, function(n){return ["failed","today",n];}));
    return $.map(habits, function(n){return [["failed","today",n]];}) }

// getFailures ∷ () → ()
var getFailures = function() {
    $.ajax({
        type: "GET",
        url: "/api/failures/today"
        }).done(function(habitsStr) {
            var habits = JSON.parse(habitsStr);
            console.log(habits);
            console.log(habits[0]);
            displayNotices(failureNotices(habits)); })}

// didIt ∷ {day,habit} → () → ()
var didIt = function(day, habit) {
    return function() {
        $.ajax({
            type: "PUT",
            url: "/api/successes/" + day + "/" + habit,
            success: function(d){getFailures($.getJSON(d)); }})}; }

// showNotice ∷ {Notice} → LI
var showNotice = function(notice) {
    var result = $("<li>")
    console.log(notice);
    switch (notice[0]) {
        case "failed":
            result.text("You failed at [" + notice[2] + "] today.");
            result.click(didIt(notice[1], notice[2]))
            return result;
        case "chain":
            result.text("You've been doing [" + notice[1] + (
                "] for " + notice[2] + " days in a row!"))
            return result
        default:
            throw("Invalid notice"); }}

var displayNotices = function(notices) {
    var LIs = $.map(notices, showNotice)
    var node = $("#notices");
    node.empty()
    for (var i in LIs) { node.append(LIs[i]); }; }

var ex = [["failed","today","curfew"], ["chain","breakfast",2]];

// displayNotices(ex);
getFailures();

</script>
</body>
</html>

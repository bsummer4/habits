<html><head></head><body>

<p>
	<form name="x" action="javascript:addHabitHandler()">
		Add a habit
		<input name="habit" value="habit" type="text" id="habit"></input>
		</form>
	<ul id="notices"></ul>
	</p>

<script src="http://code.jquery.com/jquery-1.11.0.min.js"></script>
<script>
// You still need to do $h, $i, $j, and $k today.
// Yesterday, you fucked up on $h, $i, $j, and $k.
// Gratz! You've been doing $h for $x days in a row!
// Gratz! You've been doing $k for $y days in a row!
// (["api","chains"],"GET",[("upto",d)])
// (["api","habits"],"LIST",[])
// (["api","habits",h],"PUT",[])
// (["api","habits",h],"DELETE",[])
// (["api","habits","done"],"GET",[("day",d),("status",s)])
// (["api","habits",h,"done"],"POST",[("day",d),("status",s)])

var addHabitHandler = function(x) {
	var hab = document.getElementById("habit").value;
	addHabit(hab, update); }

var trace = function(x) { console.log(x); return x; }

var json = function(s) {
	if (s) {return JSON.parse(trace(s)); }
	else {return {}}; }

var addHabit = function(habit, cont) {
    $.ajax({ type: "PUT", url: "/api/habits/" + habit })
        .done(function() { cont({}); }); }

var allHabits = function(cont) {
    $.ajax({ type: "LIST", url: "/api/habits" })
        .done(function(habitsStr) { cont(json(habitsStr)); }); }

var successes = function(day, cont) {
    $.ajax({ type: "GET", url: "/api/habits/done?status=True&day=" + day })
        .done(function(habitsStr) { cont(json(habitsStr)); }) }

var calcFailures = function(habitSet, successSet) {
    var result = [];
    for (i in habitSet) {
        if (-1 === successSet.indexOf(habitSet[i])){ result.push(habitSet[i]); }}
    return result; }

// data Notice
//     = {"failed",day,habit}
//     | {"succeeded",day,habit}
//     | {"chain",habit,length}

var habitNotices = function(day, successes, failures) {
    var f = $.map(failures, function(n){return [["failed",day,n]];});
    var s = $.map(successes, function(n){return [["succeeded",day,n]];});
    return trace(f.concat(s)); }

var update = function() {
    allHabits(function(habitSet) {
        successes("today", function(successSet) {
            var failureSet = calcFailures(habitSet,successSet);
            console.log(habitSet,failureSet,successSet);
            var notices = habitNotices("today",successSet,failureSet);
            console.log(notices);
            displayNotices(notices); }); }); }

var setDone = function(day, habit, status, cont) {
    var statusstr = "True";
    if (true!==status) { statusstr = "False"; }
    return function() {
        $.ajax({
            type: "POST",
            url: ("/api/habits/"+habit+"/done?day="+day+"&status="+statusstr),
            success: function(d){ cont({}); }})}; }

// showNotice ∷ {Notice} → LI
var showNotice = function(notice) {
    var result = $("<li>")
    console.log(notice);
    switch (notice[0]) {
        case "failed":
            result.text("You failed at [" + notice[2] + "] " + notice[1] + ".");
            result.click(setDone(notice[1], notice[2], true, update))
            return result;
        case "succeeded":
            result.text("You succeeded at [" + notice[2] + "] " + notice[1] + ".");
            result.click(setDone(notice[1], notice[2], false, update))
            return result;
        case "chain":
            result.text("You've been doing [" + notice[1] + (
                "] for " + notice[2] + " days in a row!"))
            return result
        default:
            throw("Invalid notice"); }}

var displayNotices = function(notices) {
    var LIs = $.map(notices, showNotice)
    var node = $("#notices");
    node.empty()
    for (var i in LIs) { node.append(LIs[i]); }; }

var ex = [["failed","today","curfew"], ["chain","breakfast",2]];

// displayNotices(ex);
update();

</script>
</body>
</html>
